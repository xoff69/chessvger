/*
 * This source file was generated by the Gradle 'init' task
 */

package com.xoff.chessvger.parser.game;

import com.xoff.chessvger.util.Topic;
import java.io.File;
import java.sql.SQLException;
import java.util.List;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPubSub;

public class RunGameParser implements Runnable {
  /**
   * @param filedir ex /data/twic114
   */
  private static void manageFile(String filedir) {
    System.out.println("games " + filedir);
    CommonGameDao commonGameDao = new CommonGameDao();

    Parser parser = new Parser();
    List<CommonGame> games = parser.parseDir(new File(filedir));
    System.out.println("games " + games.size());
    long id = 1L;
    for (CommonGame game : games) {

      game.setId(id++);

      try {
        commonGameDao.insertCommonGame(game);
      } catch (SQLException e) {
        throw new RuntimeException(e);
      } catch (ClassNotFoundException e) {
        throw new RuntimeException(e);
      }
      // mettre a jour le reconciliation manager
      // envoyer sur les stats browser
      // envoyer game of player
      // List<CoupleZobristMaterial> list = MaterialPositionsUtil.parseMoves2(game.getMoves());
      // PositionMaterialProducer.enqueuePositionMaterial(game.getId(), list);
      //enqueueGameOfAPlayer(game.getId(), game.getWhiteFideId());
      //enqueueGameOfAPlayer(game.getId(), game.getBlackFideId());
      //ReconciliationManager.update(game.getId(), ReconciliationType.GAME);
    }
    System.out.println("db insert games done " + games.size());
  }

  @Override
  public void run() {


    System.out.println("Start parse");
    try (Jedis jedis = new Jedis("redis", 6379)) {
      // Define a new JedisPubSub instance to handle messages
      JedisPubSub pubSub = new JedisPubSub() {
        @Override
        public void onMessage(String channel, String message) {
          System.out.println("Received message from channel " + channel + ": " + message);
          String filename = "./data/twic";
          manageFile(filename);
          System.out.println("finish to parse:" + filename);
        }
      };

      jedis.subscribe(pubSub, Topic.TOPIC_GAME);
    }



  }


}
